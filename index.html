<!DOCTYPE html>
    <html>
        <head>
            <style>
                #torso {
                    position:absolute;
                    user-select: none;
                    transform: translate(-50%, -50%);
                    z-index: -5;
                }
                #head {
                    position:absolute;
                    user-select: none;
                    transform: translate(-50%, -130%);
                    z-index: -2;
                    transform-origin: center 45%;
                }
                #weapon {
                    position: absolute;
                    user-select: none;
                    transform: translate(-50%, -50%);
                    z-index: -4;
                }
                body {
				    overflow: hidden;
                    height: 100%;
                    user-select: none;
				}
                #background {
                    position:absolute;
                    transform:translate(-50%, -50%);
                    z-index: -100;
                    user-select: none;
                    -webkit-user-drag: none;
                }
            </style>
        </head>
        <body>
            <div id = "torso"></div>
            <div id = "background"></div>
            <div id = "head"></div>
            <div id = "weapon"></div>
            <script>
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                var mouseX = 0;
                var mouseY = 0;
                var angle = 0;
                var degrees = 0;
                var xvel = 0;
                var yvel = 0;
                var upPressed = false;
				var leftPressed = false;
				var downPressed = false;
				var rightPressed = false;
				var spacePressed = false;
				var ePressed = false;
                var shiftPressed = false;
                var dodgeCooldown = 0;
                var iframes = 0;
                var swinging = false;
                var swingTime = 0;
                var swingVel = 0;
                var swingCurrentAngle = 0;
                var combo = 1;
                var mouseDown = false;
                var attackCharge = 0;
                var weaponBaseSize = 1;
                var currParticleImage = "";
                var AR = 100;
                var weaponAngle = 0;
                document.addEventListener('keydown', (event) => {
  				if (event.key === 'w' || event.key === 'W') {
     				   upPressed = true;
   				 } else if (event.key === 's' || event.key === 'S') {
     				   downPressed = true;
   				 } else if (event.key === 'a' || event.key === 'A') {
     				   leftPressed = true;
  				 } else if (event.key === 'd' || event.key === 'D') {
   				     rightPressed = true;
   				 } else if (event.key === ' ') {
   				     spacePressed = true;
   				 } else if (event.key === 'e' || event.key === 'E') {
   				     ePressed = true;
   				 }
                if (event.shiftKey) {
                    shiftPressed = true;
                }
				});
				document.addEventListener('keyup', (event) => {
  				if (event.key === 'w' || event.key === 'W') {
     				   upPressed = false;
   				 } else if (event.key === 's' || event.key === 'S') {
     				   downPressed = false;
   				 } else if (event.key === 'a' || event.key === 'A') {
     				   leftPressed = false;
  				 } else if (event.key === 'd' || event.key === 'D') {
   				     rightPressed = false;
   				 } else if (event.key === ' ') {
   				     spacePressed = false;
   				 } else if (event.key === 'e' || event.key === 'E') {
   				     ePressed = false;
   				 }
                if (event.shiftKey) {
                    shiftPressed = false;
                }
                });
                addEventListener("mousemove", e => {
                    mouseX = e.pageX - window.screen.width*0.5;
                    mouseY = e.pageY - window.screen.height*0.5 + 42;
                    angle = Math.atan2(mouseY, mouseX)
                    degrees = angle * 180/ Math.PI
                });
                addEventListener('mousedown', function(event) {
                    if (event.button === 0 && swingTime <= 0) {
                        mouseDown = true;
                    } 
                });
                addEventListener('mouseup', function(event) {
                    if (event.button === 0 && swingTime <= 0) {
                        mouseDown = false;
                        swingTime = 150;
                        wElement.style.transform = "translate(-50%, -50%) rotate(" + (degrees - combo*60 + 90*(combo - 1)) + "deg)" + "scaleX(" + (1 + (attackCharge/400)) + ") scaleY(" + (1 + (attackCharge/400)) + ")";
                        wElement.style.left = ((window.screen.width*0.5 - (attackCharge/700 + 1)*(70*Math.cos(angle + combo*Math.PI/5) + 2*(Math.random() - Math.random())))) + "px";
                        wElement.style.top = ((window.screen.height*0.5 - (attackCharge/700 + 1)*(70*Math.sin(angle + combo*Math.PI/5) + 2*(Math.random() - Math.random())))) + "px";
                        swingCurrentAngle = angle;
                        swingVel = 0;
                    }
                });
                function spawnClouds() {
    				var cloudSize = Math.random();
   				    var cloudElement = document.createElement("div");
    				var cloudElement2 = document.createElement("div");
    				cloudElement.classList.add('cloud');
    				cloudElement.creationTime = Date.now();
    				cloudElement.angle = degrees * Math.PI / 180 + 0.5 * (Math.random() - Math.random());
				    cloudElement.speed = -1.5 * Math.random() - 0.5;
    				document.body.appendChild(cloudElement);
    				cloudElement.innerHTML = "<img src=\'cloud.gif\' width=\'64px\' height=\'64px\'>";
   				    cloudElement.style.position = "absolute";
    				cloudElement.style.top = window.screen.height*0.5 - 25 + 30*Math.random() - 50*Math.random() + "px";
   				    cloudElement.style.left = window.screen.width*0.5 - 25 + 30*Math.random() - 30*Math.random() + "px";
				    cloudElement.x = parseFloat(cloudElement.style.left);
				    cloudElement.y = parseFloat(cloudElement.style.top);
        			cloudElement.style.transform = "rotate(" + (360 * Math.random()) + "deg) scale(" + cloudSize + "," + cloudSize + ")";
				}
                function manageClouds() {
    						var clouds = document.getElementsByClassName("cloud");
    						const cloud_LIFETIME = 200;
    						const time = Date.now();
    						for (const cloud of clouds) {
        					const sinceCreation = time - cloud.creationTime;
        					if (sinceCreation > cloud_LIFETIME) {
            						cloud.remove();
        					} else {
							cloud.x = parseFloat(cloud.style.left);
							cloud.y = parseFloat(cloud.style.top);
            						cloud.style.opacity = (cloud_LIFETIME - sinceCreation) / cloud_LIFETIME;
            						cloud.style.left = parseFloat(cloud.style.left) + cloud.speed * (Math.cos(cloud.angle)) / (1 - sinceCreation / 200) + "px";
            						cloud.style.top = parseFloat(cloud.style.top) + cloud.speed * (Math.sin(cloud.angle)) / (1 - sinceCreation / 200) + "px";
                                    cloud.style.left = (parseFloat(cloud.style.left) - xvel) + "px";
                                    cloud.style.top = (parseFloat(cloud.style.top) - yvel) + "px";
        					}
    					}
				}
                function Particle(x,y,angle,height,width,duration, separate, hvel, vvel) {
                    var particleElement = document.createElement("div");
                    particleElement.classList.add('particle');
                    particleElement.creationTime = Date.now();
                    particleElement.duration = duration;
                    particleElement.angle = angle;
                    document.body.appendChild(particleElement);
                    particleElement.innerHTML = "<img src=\'" + currParticleImage + "\' width=\'" + width +"px\' height=\'"+ height + "px\'>";
                    particleElement.style.position = "absolute";
                    particleElement.style.top = y + "px";
                    particleElement.style.left = x + "px";
                    particleElement.style.transform = " translate(-50%, -50%) rotate(" + angle + "deg)";
                    particleElement.separate = separate;
                    particleElement.style.zIndex = -3;
                    particleElement.hvel = hvel;
                    particleElement.vvel = vvel;
                }
                function manageParticles() {
                        var particles = document.getElementsByClassName("particle");
                        const time = Date.now();
                        for (const particle of particles) {
                            const sinceCreation = time - particle.creationTime;
                            particle.style.left = (parseFloat(particle.style.left) + particle.hvel) + "px";
                            particle.style.top = (parseFloat(particle.style.top) + particle.vvel) + "px";
                            if (sinceCreation > particle.duration) {
                                particle.remove();
                            } else {
                                particle.duration -= 1;
                                particle.style.opacity = (particle.duration - sinceCreation)/particle.duration;
                                if (particle.separate == 1) {
                                    particle.style.left = (parseFloat(particle.style.left) - xvel) + "px";
                                    particle.style.top = (parseFloat(particle.style.top) - yvel) + "px";
                                }
                            }
                        }
                }
                function Wisp() {
                    var wispElement = document.createElement("div");
                    var initAngle = 360*Math.random();
                    wispElement.classList.add('wisp');
                    wispElement.creationTime = Date.now();
                    document.body.appendChild(wispElement);
                    wispElement.innerHTML = "<img src=\'wisp.gif\' width=\'" + 64 + "px\' height=\'"+ 64 + "px\'>";
                    wispElement.style.position = "absolute";
                    wispElement.y = 0.5*window.screen.height + 2500*Math.sin(initAngle);
                    wispElement.x = 0.5*window.screen.width + 2500*Math.cos(initAngle);
                    wispElement.xvel = 0;
                    wispElement.yvel = 0;
                    wispElement.style.transform = " translate(-50%, -50%) rotate(0deg)";
                    wispElement.style.opacity = 1;
                    wispElement.health = 100;
                    wispElement.style.transformOrigin = "center center";
                    wispElement.watchDistance = 400 + 200*(Math.random() - Math.random());
                    wispElement.meleeVul = true;
                }
                function manageWisps() {
                        var wisps = document.getElementsByClassName("wisp");
                        var swordXOverlap = false;
                        var swordYOverlap = false;
                            for (const wisp of wisps) {
                                if (swingTime <= 0) {
                                    wisp.meleeVul = true;
                                }
                                var wispAngle = Math.atan2((0.5*window.screen.height - wisp.y) , (0.5*window.screen.width - wisp.x));
                                const relX = wisp.x - parseFloat(wElement.style.left);
                                const relY = wisp.y - parseFloat(wElement.style.top);
                                var rotatedX = (relX)*Math.cos(-1*weaponAngle) - (relY)*Math.sin(-1*weaponAngle);
                                var rotatedY = (relX)*Math.sin(-1*weaponAngle) + (relY)*Math.cos(-1*weaponAngle);
                                    if ((-65*(1 + (attackCharge/400)) - 32) <= rotatedX && rotatedX <= (60*(1 + (attackCharge/400)) + 32)) {
                                        swordXOverlap = true;
                                    } else {
                                        swordXOverlap = false;
                                    }
                                    if ((-13*(1 + (attackCharge/400)) - 32) <= rotatedY && rotatedY <= (13*(1 + (attackCharge/400)) + 32)) {
                                        swordYOverlap = true;
                                    } else {
                                        swordYOverlap = false;
                                    }
                                if (wisp.meleeVul == true && swordXOverlap == true && swingTime > 0 && swordYOverlap == true) {
                                    wisp.health -= AR;
                                    wisp.meleeVul = false;
                                }
                            if (wisp.health <= 0) {
                                for(i = 0; i < 5; i++) {
                                    currParticleImage = "cloud.gif";
                                    Particle(wisp.x + 16*(Math.random() - Math.random()), wisp.y + 16*(Math.random() - Math.random()), 360*Math.random(), 64, 64, 1000, 1, 0.5*(Math.random() - Math.random()), 0.5*(Math.random() - Math.random()))
                                }
                                wisp.remove();
                            } else {
                                wisp.style.left = wisp.x + "px";
                                wisp.style.top = wisp.y + "px"
                                wisp.style.transform = "translate(-50%, -50%) rotate(" + (180*wispAngle)/(Math.PI) +"deg)";
                                wisp.x -= xvel;
                                wisp.y -= yvel;
                                if (Math.sqrt(((0.5*window.screen.height - wisp.y)*(0.5*window.screen.height - wisp.y))+((0.5*window.screen.width - wisp.x)*(0.5*window.screen.width - wisp.x))) >= wisp.watchDistance){
                                    wisp.xvel += 0.2*Math.cos(wispAngle);
                                    wisp.yvel += 0.2*Math.sin(wispAngle);
                                } else {
                                    wisp.xvel -= 0.1*Math.cos(wispAngle);
                                    wisp.yvel -= 0.1*Math.sin(wispAngle);
                                }
                                
                                wisp.xvel *= 0.9;
                                wisp.yvel *= 0.9;
                                wisp.x += wisp.xvel;
                                wisp.y += wisp.yvel;
                            }
                        }
                }


                const torsoElement = document.getElementById('torso');
                torsoElement.style.top = window.screen.height*0.5 + "px";
				torsoElement.style.left = window.screen.width*0.5 + "px";
				torsoElement.innerHTML = "<img src=\'torso.gif\' width=\'50px\' height=\'50px\'>";
                const headElement = document.getElementById('head');
                headElement.style.top = window.screen.height*0.5 + "px";
				headElement.style.left = window.screen.width*0.5 + "px";
				headElement.innerHTML = "<img src=\'head.gif\' width=\'30px\' height=\'30px\'>";
                const bgElement = document.getElementById('background');
                bgElement.style.top = window.screen.height*0.5 + "px";
				bgElement.style.left = window.screen.width*0.5 + "px";
                bgElement.innerHTML = "<img src=\'arena.gif\' width=\'5000px\' height=\'5000px\' draggable='false'>";
                const wElement = document.getElementById('weapon');
                wElement.innerHTML = "<img src=\'black-splinter.png\' width=\'20px\' height=\'100px\'>";
                function handleTick(){
                    weaponAngle = (Math.PI)*((swingCurrentAngle*180/Math.PI) - combo*60 + 90*(combo-1))/180;
                    if (mouseDown && swingTime <= 0) {
                            attackCharge += 1;
                    }

                    if (leftPressed == true) {
                        xvel -= 0.1;
                    } 
                    if (rightPressed == true){
                        xvel += 0.1;
                    }
                    if (upPressed == true) {
                        yvel -= 0.1;
                    }
                    if (downPressed == true) {
                        yvel += 0.1;
                    }
                    if (spacePressed == true && dodgeCooldown <= 0) {
                        dodgeCooldown = 100;
                        iframes = 40;
                        xvel += 8*Math.cos(angle);
                        yvel += 8*Math.sin(angle);
                    }
                    if (degrees <= 90 && degrees >= -90) {
                        torsoElement.style.transform = "scaleX(1) translate(-50%, -50%)";
                        headElement.style.transform = "translate(-50%, -140%) rotate(" + degrees + "deg)";
                    } else {
                        torsoElement.style.transform = "scaleX(-1) translate(50%, -50%)";
                        headElement.style.transform = "translate(-50%, -140%) rotate(" + degrees + "deg)";
                    }
                    yvel *= 0.96;
                    xvel *= 0.96;
                    bgElement.style.left = (parseFloat(bgElement.style.left) - xvel) + "px";
                    bgElement.style.top = (parseFloat(bgElement.style.top) - yvel) + "px";
                    iframes -= 1;
                    dodgeCooldown -= 1;
                    if (iframes > 0) {
                        torsoElement.style.opacity = 0.1;
                        headElement.style.opacity = 0.1;
                            spawnClouds();
                    } else {
                        torsoElement.style.opacity = 1;
                        headElement.style.opacity = 1;
                    }
                    manageClouds();
                    manageParticles();
                    manageWisps();
                    if (swingTime <= 0 && !mouseDown) {
                        wElement.style.opacity = 0;
                    }
                    if (combo == 1) {
                        wElement.innerHTML = "<img src=\'black-splinter.png\' width=\'20px\' height=\'100px\'>";
                    } else {
                        wElement.innerHTML = "<img src=\'black-splinter-flipped.png\' width=\'20px\' height=\'100px\'>";
                    }
                    if (swingTime <= 0 && mouseDown) {
                        wElement.style.transform = "translate(-50%, -50%) rotate(" + (degrees - combo*60 + 90*(combo - 1)) + "deg)" + "scaleX(" + (1 + (attackCharge/400)) + ") scaleY(" + (1 + (attackCharge/400)) + ")";
                        wElement.style.left = ((window.screen.width*0.5 - (attackCharge/550 + 1)*(70*Math.cos(angle + combo*Math.PI/5) + 2*(Math.random() - Math.random())))) + "px";
                        wElement.style.top = ((window.screen.height*0.5 - (attackCharge/550 + 1)*(70*Math.sin(angle + combo*Math.PI/5) + 2*(Math.random() - Math.random())))) + "px";
                        swingCurrentAngle = angle;
                        swingVel = 0;
                        wElement.style.opacity = Math.log(attackCharge)/100;
                    } else if(swingTime > 0){
                        currParticleImage = "sword-trail.png";
                        Particle((window.screen.width*0.5 - (attackCharge/550 + 1)*(70*Math.cos(swingCurrentAngle + combo*Math.PI/7))), (window.screen.height*0.5 - (attackCharge/550 + 1)*(70*Math.sin(swingCurrentAngle + combo*Math.PI/7))), ((swingCurrentAngle*180/Math.PI) - combo*65 + 90*(combo-1)), (100*(1 + (attackCharge/400))), (25*(1 + (attackCharge/400))), 300, 0, 0, 0)
                        swingCurrentAngle += swingVel;
                        wElement.style.transform = "translate(-50%, -50%) rotate(" + ((swingCurrentAngle*180/Math.PI) - combo*60 + 90*(combo-1)) + "deg)" + "scaleX(" + (1 + (attackCharge/400)) + ") scaleY(" + (1 + (attackCharge/400)) + ")";
                        wElement.style.left = (window.screen.width*0.5 - (attackCharge/550 + 1)*(70*Math.cos(swingCurrentAngle + combo*Math.PI/5))) + "px";
                        wElement.style.top = (window.screen.height*0.5 - (attackCharge/550 + 1)*(70*Math.sin(swingCurrentAngle + combo*Math.PI/5))) + "px";
                        if (swingTime > 74) {
                            wElement.style.opacity = (parseFloat(wElement.style.opacity) + 0.03);
                            swingVel += combo*0.00085;
                        } else {
                            swingVel -= combo*0.00085;
                            wElement.style.opacity = (parseFloat(wElement.style.opacity) - 0.03);
                        }
                        if (swingTime == 1) {
                            combo *= -1;
                            attackCharge = 0;
                        }
                        swingTime -= 1;
                    }
                }

                let intervalId = setInterval(() => handleTick(), 1);
                for(i = 0; i < 40; i++){
                    Wisp();
                }
            </script>
        </body>
    </html>